<!DOCTYPE html>
<html>
<head>
</head>
<body>
	<h1>Enter a twitter screen name below</h1>
	<form>
		<label for="name">Twitter user name:</label><br>
		<input type="text" id="name" name="name" placeholder="ex: realDonaldTrump"><br><br>
		<input type="submit" value="Submit">
	</form>
	
	<div id="container" style="padding: 30px; margin-top: 30px;">
		<img src="" id="profile-picture" />
		<a id="profile-link" href="" target="_blank"><h3 id="twitter-user"></h3></a>
		<h4 id="twitter-followers"></h4>
		<ul id="tweet-list"></ul>
	</div>
	
	<script src="https://sdk.amazonaws.com/js/aws-sdk-2.741.0.min.js"></script>
	<script type="text/javascript">
	// Initialize the Amazon Cognito credentials provider
	AWS.config.region = 'eu-central-1'; // Region
	AWS.config.credentials = new AWS.CognitoIdentityCredentials({
		IdentityPoolId: 'eu-central-1:???',
	});
		
	const lambda = new AWS.Lambda();
	/* Screen name submit button */	
	document.querySelector('form').onsubmit = (e) => {
		e.preventDefault();
		const screenName = e.target[0].value;
		fetchTweets(screenName);
		
	};
	
	/* fetch the tweets */
	const fetchTweets = (screenName) => {
		document.querySelector('input[type="submit"]').setAttribute("disabled", "disabled");
		/* construct payload */
		const payload = JSON.stringify({screenName: screenName}); 
		const params = {
			FunctionName: 'tweetSpy2', 
			Payload: payload
		};
		/* Invokation of tweetSpy2 - function that fetches tweets */
		lambda.invoke(params, function(err, data) {  
			if (err) { 
				console.log(err, err.stack)
			} else {
				data = JSON.parse(data.Payload);
				data = JSON.parse(data.body);
				const user = data[0].user;
				const userName = user.name + " (@" + screenName + ")";
				const profileImage = user.profile_image_url_https;
				const followers = user.followers_count;
				
				/* Inserts profile pic, screen name link, number of followers... */
				document.querySelector("#twitter-user").innerHTML = userName;
				document.querySelector("#profile-link").setAttribute("href", "https://twitter.com/" + screenName);
				document.querySelector("#twitter-followers").innerHTML = "Followers: " + followers;
				document.querySelector("#profile-picture").setAttribute("src", profileImage);
				/* Creates the list of tweets on page */
				const tweets = [];
				data.forEach( tweet => {
					let li = "<li tweet-id='" + tweet.id_str + "' tweet-creation='" + tweet.created_at + "' tweet-text='" + tweet.text + "' screen-name='" + screenName +"'>";
					li += "<h4 style='margin: 0;'>" + tweet.created_at + "</h4>";
					li += "<p style='margin: 0; margin-top: 5px'>" + tweet.text + "</p>";
					li += "<button class='save-tweet'>SAVE TWEET</button>";
					li += "<button class='analyze'>Analyze</button>";
					li += "<div class='analysis-results'></div></li>";
					
					tweets.push(li)
				})
				document.querySelector('input[type="submit"]').removeAttribute("disabled");
				document.querySelector("#tweet-list").innerHTML = tweets;
		   };
		 });
		}
	
	/* Listens to click events on page */
	document.addEventListener('click', (e) => {
		/* Save a tweet */
		if ( e.target.className === 'save-tweet' ) {
			const tweetID = e.target.parentElement.getAttribute('tweet-id'); // Get the value that is stored in the attribute called 'tweet-id'
			const tweetCreation = e.target.parentElement.getAttribute('tweet-creation');
			const tweetText = e.target.parentElement.getAttribute('tweet-text');
			const screenName = e.target.parentElement.getAttribute('screen-name');
			const payload = JSON.stringify({
					tweetID: tweetID,
					tweetCreation: tweetCreation,
					tweetText: tweetText,
					screenName: screenName
			});
			/* lambda function that sends json to dynamo */
			const params = {
				FunctionName: 'serverlessrepo-json-to-dyna-JSONToDynamoDBFunction-U5095EP8M89V',
				Payload: payload
			}
			lambda.invoke( params, (err, data) => {
				if (!err) {
					e.target.setAttribute('disabled', 'disabled');
				}
			})
		}
		/* Analyze a tweet */
		if ( e.target.className === 'analyze' ) {
			const tweetID = e.target.parentElement.getAttribute('tweet-id');
			const params = {
				FunctionName: 'analyze',
				Payload: JSON.stringify({tweetID: tweetID })
			}
		
			lambda.invoke(params, (err, data) => {
				if ( !err ) {
					e.target.setAttribute("disabled", "disabled");
					let response = JSON.parse(data.Payload);
					const detectedLanguage = response.body.ResultList[0].Languages[0].LanguageCode;
					const sentiment = response.body.sentiment.ResultList[0].Sentiment;
					const entities = response.body.entities.ResultList[0].Entities;
					const entitiesLinks = "Research entities: " + entities.map( entity => {
						return "<a target='_blank' href='https://duckduckgo.com/?q=" + entity.Text + "'>" + entity.Text + "</a> ";
					});
					let analysisResults = "Detected language: " + detectedLanguage;
					analysisResults += "<br>Sentiment: " + sentiment;
					analysisResults += "<br>" + entitiesLinks;
					e.target.parentElement.querySelector(".analysis-results").innerHTML = analysisResults;
				}
			})
		}
	})
	
	</script>
</body>
</html>